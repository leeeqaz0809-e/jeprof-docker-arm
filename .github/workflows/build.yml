name: Build and Save ARM64 Image

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # 临时镜像名，用于导出
  IMAGE_TAG: jeprof-analyzer:latest

jobs:
  build-and-save:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 设置 QEMU (用于在 x86 机器上构建 ARM 镜像)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. 构建并导出为 Docker Tar 文件
      # 注意：这里我们使用了 outputs: type=docker，它会将镜像保存为本地文件
      - name: Build and Export Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          # 指定构建 ARM64 架构
          platforms: linux/arm64
          tags: ${{ env.IMAGE_TAG }}
          # 关键配置：不推送到仓库，而是输出为 tar 文件
          outputs: type=docker,dest=/tmp/jeprof-image.tar

      # 4. 压缩为 tar.gz (减小文件体积)
      - name: Compress image
        run: |
          gzip /tmp/jeprof-image.tar
          ls -lh /tmp/jeprof-image.tar.gz

      # 5. 上传为 GitHub Artifact (构建产物)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jeprof-arm64-image
          path: /tmp/jeprof-image.tar.gz
          retention-days: 3 # 文件保留3天
